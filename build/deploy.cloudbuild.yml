steps:
  - name: "gcr.io/cloud-builders/docker"
    id: 'pull cache'
    entrypoint: "bash"
    args:
      - -c
      - docker pull gcr.io/$PROJECT_ID/gffft-api:compose || exit 0

  - name: "gcr.io/cloud-builders/docker"
    id: "docker build"
    waitFor: ['pull cache']
    args:
      [
        "build",
        "--cache-from", "us-docker.pkg.dev/$PROJECT_ID/us.gcr.io/gffft-api:compose",
        "-t", "gcr.io/$PROJECT_ID/gffft-api:compose",
        "-t", "gffft-api",
        "--file", "./functions/Dockerfile",
        "./functions",
      ]

  - name: 'docker/compose:1.29.2'
    id: 'check build'
    args: [ 'run','api','npm','run','build' ]
    env: [ 'COMPOSE_HTTP_TIMEOUT=200' ]

  - name: 'docker/compose:1.29.2'
    id: "tests in docker-compose"
    args: [
      '-f', 'docker-compose.yml',
      '-f', 'docker-compose.test.yml',
      '-f', 'docker-compose.cb.yml',
      'up',
      '--exit-code-from', 'api-integration-test',
      'api-integration-test'
    ]
    env: [ 'COMPOSE_HTTP_TIMEOUT=400' ]

  - name: 'sonarsource/sonar-scanner-cli'
    id: 'sonar scan'
    env: [
        'SONAR_HOST_URL=https://sonarcloud.io',
        'SONAR_LOGIN=$$SONAR_TOKEN',
    ]
    args: [
            "-v",
            "./:/usr/src",
            "sonarsource/sonar-scanner-cli"
            ]
    secretEnv: ['SONAR_TOKEN']

  # Check linting
  - name: 'docker/compose:1.27.4'
    id: 'lint check'
    args: [ 'run','gffft-api','npm','run','lint' ]
    env: [ 'COMPOSE_HTTP_TIMEOUT=200' ]

  - name: 'gcr.io/cloud-builders/npm'
    args: ['install']
    dir: 'functions'

  - name: 'gcr.io/cloud-builders/npm'
    args: ['run', 'build']
    dir: 'functions'

  #  - name: 'gcr.io/cloud-builders/npm'
  #    args: ['test']
  #    dir: 'functions'

  - name: "gcr.io/cloud-builders/gcloud"
    args: ["app", "deploy"]
    timeout: "1600s"
    dir: 'functions'

timeout: 2400s

images:
  - "us-docker.pkg.dev/$PROJECT_ID/us.gcr.io/gffft-api:compose"
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/sonarsource-token/versions/1
      env: 'SONAR_TOKEN'


