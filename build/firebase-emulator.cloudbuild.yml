steps:
  - name: "gcr.io/cloud-builders/docker"
    id: 'pull firebase cache'
    entrypoint: "bash"
    args:
      - -c
      - docker pull ${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base || exit 0

  - name: gcr.io/cloud-builders/docker
    args:
      - run
      - '--privileged'
      - 'linuxkit/binfmt:v0.7'
    id: initialize-qemu
  - name: gcr.io/cloud-builders/docker
    args:
      - buildx
      - create
      - '--name'
      - mybuilder
    id: create-builder
    waitFor: ['initialize-qemu']
  - name: gcr.io/cloud-builders/docker
    args:
      - buildx
      - use
      - mybuilder
    id: select-builder
    waitFor: ['create-builder']
  - name: gcr.io/cloud-builders/docker
    args:
      - buildx
      - inspect
      - '--bootstrap'
    id: show-target-build-platforms
    waitFor: ['select-builder']

  - name: "gcr.io/cloud-builders/docker"
    id: "docker build firebase"
    waitFor: ['pull firebase cache', 'show-target-build-platforms']
    args:
      [
        "buildx",
        "build",
        "--platform", "$_DOCKER_BUILDX_PLATFORMS",
        "--cache-from", "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base",
        "-t", "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base",
        "--file", "./firebase-emulator/base.Dockerfile",
        "--push",
        "./",
      ]

  - name: "gcr.io/cloud-builders/docker"
    id: "docker push firebase"
    waitFor: ['docker build firebase']
    args: ["push", "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base"]

options:
  machineType: 'E2_HIGHCPU_8'
  env:
    - DOCKER_CLI_EXPERIMENTAL=enabled

timeout: 5000s

images:
  - "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base"
substitutions:
  _ARTIFACT_REPO: us-central1-docker.pkg.dev
  _DOCKER_BUILDX_PLATFORMS: 'linux/amd64,linux/arm64'
