steps:
  - name: "gcr.io/cloud-builders/docker"
    id: 'pull firebase cache'
    entrypoint: "bash"
    args:
      - -c
      - docker pull ${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base || exit 0

  - name: install buildx
    id: buildx
    uses: crazy-max/ghaction-docker-buildx@v1
    with:
      version: latest
  - name: docker build firebase
    id: "docker build firebase"
    waitFor: ['pull firebase cache']
    run: |
      docker buildx build \
      --platform $_DOCKER_BUILDX_PLATFORMS \
      --cache-from "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base" \
      -t "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base" \
      -t "gffft-firebase-emulator" \
      --file "./firebase-emulator/base.Dockerfile" \
      .

  - name: "gcr.io/cloud-builders/docker"
    id: "docker push firebase"
    waitFor: ['docker build firebase']
    args: ["push", "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base"]

options:
  machineType: 'E2_HIGHCPU_8'
  env:
    - DOCKER_CLI_EXPERIMENTAL=enabled

timeout: 5000s

images:
  - "${_ARTIFACT_REPO}/$PROJECT_ID/gffft/gffft-firebase-emulator:base"
substitutions:
  _ARTIFACT_REPO: us-central1-docker.pkg.dev
  _DOCKER_BUILDX_PLATFORMS: 'linux/amd64,linux/arm64'